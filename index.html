<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë°˜í¸ì„± í”„ë¡œê·¸ë¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* ë°˜ì‘í˜• ë¯¸ë””ì–´ ì¿¼ë¦¬ - ëª¨ë°”ì¼ (0-768px) */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem !important;
      }
      
      .main-title {
        font-size: 1.5rem !important;
        padding: 1.5rem 1rem !important;
      }
      
      .subtitle {
        font-size: 0.75rem !important;
      }
      
      .section-card {
        padding: 1rem !important;
        margin-bottom: 1rem !important;
      }
      
      .section-title {
        font-size: 1rem !important;
      }
      
      .button-small {
        padding: 0.5rem 0.8rem !important;
        font-size: 0.8rem !important;
      }
      
      .button-medium {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
      }
      
      .button-large {
        padding: 0.8rem 1.5rem !important;
        font-size: 0.9rem !important;
      }
      
      .result-card-title {
        font-size: 1.3rem !important;
      }
      
      .result-stats {
        font-size: 0.8rem !important;
      }
      
      table {
        font-size: 0.75rem !important;
      }
      
      th {
        font-size: 0.75rem !important;
        padding: 0.5rem 0.25rem !important;
      }
      
      td {
        font-size: 0.75rem !important;
        padding: 0.4rem 0.2rem !important;
      }
      
      .score-button {
        min-width: 28px !important;
        padding: 0.3rem 0.4rem !important;
        font-size: 0.8rem !important;
      }
      
      .dropdown-score-btn {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.9rem !important;
      }
      
      .special-note-btn {
        min-width: 60px !important;
        max-width: 100px !important;
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ë ˆì´ì•„ì›ƒ ë³€ê²½ */
      .upload-container {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ */
      .mobile-template-btn-before {
        display: flex !important;
      }
      
      .mobile-template-btn-after {
        display: flex !important;
      }
      
      .desktop-template-btn {
        display: none !important;
      }
    }

    /* ë°˜ì‘í˜• ë¯¸ë””ì–´ ì¿¼ë¦¬ - íƒœë¸”ë¦¿ (769px-1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .main-container {
        padding: 1.5rem !important;
      }
      
      .main-title {
        font-size: 2rem !important;
      }
      
      table {
        font-size: 0.85rem !important;
      }
      
      th, td {
        font-size: 0.85rem !important;
      }
    }

    /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
    @media (max-width: 640px) {
      .result-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
      }
      
      .button-flex {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }
      
      .button-flex button {
        width: 100% !important;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      .result-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* ëª¨ë‹¬ ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .modal-content {
        width: 90% !important;
        max-width: 90% !important;
        padding: 1.25rem !important;
        max-height: 85vh !important;
        overflow-y: auto !important;
      }
      
      .modal-title {
        font-size: 1.2rem !important;
      }
      
      .modal-button-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
      }
    }

    /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ ë° ë§ì¤„ì„ */
    .text-nowrap {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
    @media (hover: none) and (pointer: coarse) {
      button, .clickable {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìµœì í™”) */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ìµœì í™” */
    @media (max-width: 768px) {
      table {
        min-width: 100%;
      }
      
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }

      .privacy-banner {
        flex-direction: column !important;
        text-align: center !important;
      }

      .privacy-banner-icon {
        margin: 0 auto !important;
      }

      .privacy-footer {
        padding: 1rem !important;
        font-size: 0.8rem !important;
      }

      .privacy-footer br {
        display: none;
      }
    }

    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Lucide Icons as SVG components
    const Upload = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
    );

    const Settings = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3" />
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6" />
      </svg>
    );

    const Plus = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );

    const X = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    );

    const Trash2 = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6" />
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        <line x1="10" y1="11" x2="10" y2="17" />
        <line x1="14" y1="11" x2="14" y2="17" />
      </svg>
    );

    const Users = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
    );

    const Play = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3" />
      </svg>
    );

    const Download = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    );

    const Check = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="20 6 9 17 4 12" />
      </svg>
    );

    const Save = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
        <polyline points="17 21 17 13 7 13 7 21" />
        <polyline points="7 3 7 8 15 8" />
      </svg>
    );

    const Edit = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
      </svg>
    );

    function ClassAssignment() {
      // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
      React.useEffect(() => {
        try {
          const savedStudents = localStorage.getItem('class_assignment_students');
          const savedCategories = localStorage.getItem('class_assignment_categories');
          const savedScores = localStorage.getItem('class_assignment_scores');
          const savedNotes = localStorage.getItem('class_assignment_notes');
          const savedNumClasses = localStorage.getItem('class_assignment_numClasses');
          
          if (savedStudents) setStudents(JSON.parse(savedStudents));
          if (savedCategories) setCategories(JSON.parse(savedCategories));
          if (savedScores) setStudentScores(JSON.parse(savedScores));
          if (savedNotes) setStudentSpecialNotes(JSON.parse(savedNotes));
          if (savedNumClasses) setNumClasses(parseInt(savedNumClasses));
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }, []);

      // ë°ì´í„° ë³€ê²½ ì‹œ localStorageì— ìë™ ì €ì¥
      React.useEffect(() => {
        if (students.length > 0) {
          localStorage.setItem('class_assignment_students', JSON.stringify(students));
        }
      }, [students]);

      React.useEffect(() => {
        if (categories.length > 0) {
          localStorage.setItem('class_assignment_categories', JSON.stringify(categories));
        }
      }, [categories]);

      React.useEffect(() => {
        if (Object.keys(studentScores).length > 0) {
          localStorage.setItem('class_assignment_scores', JSON.stringify(studentScores));
        }
      }, [studentScores]);

      React.useEffect(() => {
        if (Object.keys(studentSpecialNotes).length > 0) {
          localStorage.setItem('class_assignment_notes', JSON.stringify(studentSpecialNotes));
        }
      }, [studentSpecialNotes]);

      React.useEffect(() => {
        localStorage.setItem('class_assignment_numClasses', numClasses.toString());
      }, [numClasses]);

      // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
      const clearAllData = () => {
        if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) {
          localStorage.clear();
          setStudents([]);
          setCategories([]);
          setStudentScores({});
          setStudentSpecialNotes({});
          setSeparatePairs([]);
          setResults(null);
          setNumClasses(3);
          setIsInputComplete(false);
          setIsEditMode(true);
          setIsResultSaved(false);
          setIsResultEditMode(false);
          setSelectedStudentsForSwap([]);
          alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      };

      const [students, setStudents] = useState([]);
      const [numClasses, setNumClasses] = useState(3);
      const [categories, setCategories] = useState([]);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [studentScores, setStudentScores] = useState({});
      const [studentSpecialNotes, setStudentSpecialNotes] = useState({});
      const [separatePairs, setSeparatePairs] = useState([]);
      const [newPair, setNewPair] = useState({ student1: '', student2: '' });
      const [results, setResults] = useState(null);
      const [showClassModal, setShowClassModal] = useState(false);
      const [showCategoryModal, setShowCategoryModal] = useState(false);
      const [activeScoreDropdown, setActiveScoreDropdown] = useState(null);
      const [activeSpecialNoteDropdown, setActiveSpecialNoteDropdown] = useState(null);
      const [isInputComplete, setIsInputComplete] = useState(false);
      const [isEditMode, setIsEditMode] = useState(true);
      const [selectedStudentsForSwap, setSelectedStudentsForSwap] = useState([]);
      const [isResultSaved, setIsResultSaved] = useState(false);
      const [isResultEditMode, setIsResultEditMode] = useState(false);
      const [nameSortOrder, setNameSortOrder] = useState(null); // null, 'asc', 'desc'
      const [genderSortOrder, setGenderSortOrder] = useState(null); // null, 'male-first', 'female-first'
      const [password, setPassword] = useState('');
      const [isPasswordSet, setIsPasswordSet] = useState(false);
      const [inputPassword, setInputPassword] = useState('');
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [showPasswordModal, setShowPasswordModal] = useState(false);
      const [passwordAttempts, setPasswordAttempts] = useState(0);

      const specialNoteOptions = ['ìš´ë™ë¶€', 'ë„ì›€ë°˜', 'ìŒìƒì•„', 'ë‹¤ë¬¸í™”'];

      // ì´ˆê¸° ë¡œë“œ: localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      React.useEffect(() => {
        try {
          const savedPassword = localStorage.getItem('class_assignment_password');
          const savedData = localStorage.getItem('class_assignment_data');
          
          if (savedPassword) {
            // ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŒ
            setIsPasswordSet(true);
            setPassword(savedPassword);
            setIsUnlocked(false); // ì ê¸ˆ ìƒíƒœ
          } else {
            // ì²˜ìŒ ì‚¬ìš© - ë¹„ë°€ë²ˆí˜¸ ì„¤ì • í•„ìš”
            setIsPasswordSet(false);
            setIsUnlocked(false); // ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
          }
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
          setIsPasswordSet(false);
          setIsUnlocked(false);
        }
      }, []);

      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      const checkPassword = () => {
        const trimmedInput = inputPassword.trim();
        const trimmedPassword = password.trim();
        
        if (trimmedInput === trimmedPassword) {
          setIsUnlocked(true);
          setShowPasswordModal(false);
          setPasswordAttempts(0); // ì„±ê³µ ì‹œ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
          
          // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
          try {
            const savedData = localStorage.getItem('class_assignment_data');
            if (savedData) {
              const data = JSON.parse(savedData);
              setStudents(data.students || []);
              setNumClasses(data.numClasses || 3);
              setCategories(data.categories || []);
              setStudentScores(data.studentScores || {});
              setStudentSpecialNotes(data.studentSpecialNotes || {});
              setSeparatePairs(data.separatePairs || []);
              setResults(data.results || null);
              setIsInputComplete(data.isInputComplete || false);
              setIsEditMode(data.isEditMode !== undefined ? data.isEditMode : true);
            }
          } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
          }
        } else {
          const newAttempts = passwordAttempts + 1;
          setPasswordAttempts(newAttempts);
          
          if (newAttempts >= 5) {
            // 5íšŒ ì‹¤íŒ¨ ì‹œ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ 5íšŒ í‹€ë ¸ìŠµë‹ˆë‹¤.\në³´ì•ˆì„ ìœ„í•´ ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.');
            localStorage.clear();
            window.location.reload();
          } else {
            alert(`ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (${newAttempts}/5)`);
            setInputPassword('');
          }
        }
      };

      // ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
      const setNewPassword = (pwd) => {
        const trimmedPwd = pwd.trim();
        if (trimmedPwd.length === 4 && /^\d{4}$/.test(trimmedPwd)) {
          setPassword(trimmedPwd);
          setIsPasswordSet(true);
          setIsUnlocked(true);
          localStorage.setItem('class_assignment_password', trimmedPwd);
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
      };

      // ìë™ ì €ì¥
      React.useEffect(() => {
        if (isUnlocked && isPasswordSet) {
          const dataToSave = {
            students,
            numClasses,
            categories,
            studentScores,
            studentSpecialNotes,
            separatePairs,
            results,
            isInputComplete,
            isEditMode
          };
          
          localStorage.setItem('class_assignment_data', JSON.stringify(dataToSave));
        }
      }, [students, numClasses, categories, studentScores, studentSpecialNotes, separatePairs, results, isInputComplete, isEditMode, isUnlocked, isPasswordSet]);

      // ì™„ì „ ì´ˆê¸°í™” í•¨ìˆ˜
      const resetAll = () => {
        if (confirm('ëª¨ë“  ë°ì´í„°ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          const confirmPassword = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
          if (confirmPassword === password) {
            localStorage.clear();
            window.location.reload();
          } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
          }
        }
      };

      // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨/ì¢…ë£Œ ì‹œ ê²½ê³  ì œê±° (ìë™ ì €ì¥ë˜ë¯€ë¡œ)
      React.useEffect(() => {
        // ìë™ ì €ì¥ë˜ë¯€ë¡œ ê²½ê³  ë¶ˆí•„ìš”
        return () => {};
      }, []);

      const categoryExamples = [
        'ì„±ì ', 'í•™ìŠµíƒœë„', 'êµìš°ê´€ê³„', 'ë¦¬ë”ì‹­', 
        'í˜‘ë™ì„±', 'ì£¼ì˜ì§‘ì¤‘ë ¥', 'ì±…ì„ê°', 'ì‚¬íšŒì„±'
      ];

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const workbook = XLSX.read(event.target.result, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const data = XLSX.utils.sheet_to_json(sheet);

          const formattedStudents = data.map((row, index) => {
            // ì„±ë³„ ì •ê·œí™”: ë‚¨/M â†’ ë‚¨ì„±, ì—¬/F â†’ ì—¬ì„±
            let gender = row['ì„±ë³„'] || row['gender'] || '';
            if (gender === 'ë‚¨' || gender === 'M') {
              gender = 'ë‚¨ì„±';
            } else if (gender === 'ì—¬' || gender === 'F') {
              gender = 'ì—¬ì„±';
            }
            
            return {
              id: index,
              studentId: row['í•™ìƒê°œì¸ë²ˆí˜¸'] || '',
              name: row['ì´ë¦„'] || row['name'] || '',
              gender: gender,
              grade: row['í•™ë…„'] || row['grade'] || '',
              originalClass: row['ë°˜'] || row['ì›ë˜ë°˜'] || row['class'] || '',
              number: row['ë²ˆí˜¸'] || row['number'] || '',
              birthDate: row['ìƒë…„ì›”ì¼'] || '',
              specialNote: row['íŠ¹ì´ì‚¬í•­'] || ''
            };
          });

          setStudents(formattedStudents);
          setStudentScores({});
          setResults(null);
        };
        reader.readAsBinaryString(file);
      };

      const clearStudentData = () => {
        if (confirm('ì—…ë¡œë“œí•œ í•™ìƒ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          // íŒŒì¼ input ì´ˆê¸°í™”
          const fileInput = document.querySelector('input[type="file"]');
          if (fileInput) {
            fileInput.value = '';
          }
          
          setStudents([]);
          setStudentScores({});
          setStudentSpecialNotes({});
          setResults(null);
          setIsInputComplete(false);
          setIsEditMode(true);
          setSelectedStudentsForSwap([]);
          setIsResultSaved(false);
          setIsResultEditMode(false);
          setNameSortOrder(null);
          setGenderSortOrder(null);
        }
      };

      const downloadTemplate = () => {
        // ì–‘ì‹ ë°ì´í„° ìƒì„±
        const templateData = [
          { 'í•™ìƒê°œì¸ë²ˆí˜¸': '2024001', 'í•™ë…„': '3', 'ë°˜': '1', 'ë²ˆí˜¸': '1', 'ì´ë¦„': 'í™ê¸¸ë™', 'ì„±ë³„': 'ë‚¨ì„±', 'ìƒë…„ì›”ì¼': '2017-03-15', 'íŠ¹ì´ì‚¬í•­': '', 'ì›ë˜ë°˜': '1', 'ë°°ì •ë°˜': '' },
          { 'í•™ìƒê°œì¸ë²ˆí˜¸': '2024002', 'í•™ë…„': '3', 'ë°˜': '1', 'ë²ˆí˜¸': '2', 'ì´ë¦„': 'ê¹€ì˜í¬', 'ì„±ë³„': 'ì—¬ì„±', 'ìƒë…„ì›”ì¼': '2017-05-20', 'íŠ¹ì´ì‚¬í•­': '', 'ì›ë˜ë°˜': '1', 'ë°°ì •ë°˜': '' },
          { 'í•™ìƒê°œì¸ë²ˆí˜¸': '2024003', 'í•™ë…„': '3', 'ë°˜': '1', 'ë²ˆí˜¸': '3', 'ì´ë¦„': 'ì´ì² ìˆ˜', 'ì„±ë³„': 'ë‚¨ì„±', 'ìƒë…„ì›”ì¼': '2017-08-10', 'íŠ¹ì´ì‚¬í•­': '', 'ì›ë˜ë°˜': '1', 'ë°°ì •ë°˜': '' },
        ];

        // ì›Œí¬ì‹œíŠ¸ ìƒì„±
        const worksheet = XLSX.utils.json_to_sheet(templateData);
        
        // ì›Œí¬ë¶ ìƒì„±
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'í•™ìƒëª…ë ¬í‘œ');

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        XLSX.writeFile(workbook, 'í•™ìƒëª…ë ¬í‘œ_ì–‘ì‹.xlsx');
      };

      const handleComplete = () => {
        if (students.length === 0) {
          alert('í•™ìƒ ëª…ë ¬í‘œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
          return;
        }
        if (categories.length === 0) {
          alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ íŠ¹ì„± ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          return;
        }
        alert('ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë°˜í¸ì„± ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      };

      const addCategory = () => {
        if (newCategoryName.trim()) {
          setCategories([...categories, { id: Date.now(), name: newCategoryName }]);
          setNewCategoryName('');
        }
      };

      const toggleCategoryFromModal = (categoryName) => {
        const existingCategory = categories.find(cat => cat.name === categoryName);
        if (existingCategory) {
          // ì´ë¯¸ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ë©´ ì‚­ì œ
          removeCategory(existingCategory.id);
        } else {
          // ì—†ìœ¼ë©´ ì¶”ê°€
          setCategories([...categories, { id: Date.now(), name: categoryName }]);
        }
      };

      const selectNumClasses = (num) => {
        setNumClasses(num);
        setShowClassModal(false);
      };

      const toggleScoreDropdown = (studentId, categoryId) => {
        if (!isEditMode) {
          alert('ì…ë ¥ ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜í•´ì£¼ì„¸ìš”.');
          return;
        }
        const key = `${studentId}-${categoryId}`;
        if (activeScoreDropdown === key) {
          setActiveScoreDropdown(null);
        } else {
          setActiveScoreDropdown(key);
        }
      };

      const toggleSpecialNoteDropdown = (studentId) => {
        if (!isEditMode) {
          alert('ì…ë ¥ ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜í•´ì£¼ì„¸ìš”.');
          return;
        }
        if (activeSpecialNoteDropdown === studentId) {
          setActiveSpecialNoteDropdown(null);
        } else {
          setActiveSpecialNoteDropdown(studentId);
        }
      };

      const selectScore = (studentId, categoryId, score) => {
        const newScores = { ...studentScores };
        if (!newScores[studentId]) {
          newScores[studentId] = {};
        }
        newScores[studentId][categoryId] = score;
        setStudentScores(newScores);
        setActiveScoreDropdown(null);
      };

      const toggleSpecialNote = (studentId, note) => {
        const newNotes = { ...studentSpecialNotes };
        if (!newNotes[studentId]) {
          newNotes[studentId] = [];
        }
        
        const currentNotes = [...newNotes[studentId]];
        const index = currentNotes.indexOf(note);
        
        if (index > -1) {
          // ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì œê±°
          newNotes[studentId] = currentNotes.filter((_, i) => i !== index);
        } else {
          // ì„ íƒë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì¶”ê°€
          newNotes[studentId] = [...currentNotes, note];
        }
        
        setStudentSpecialNotes(newNotes);
        
        // íŠ¹ì´ì‚¬í•­ ì„ íƒ í›„ ë“œë¡­ë‹¤ìš´ ìë™ìœ¼ë¡œ ë‹«ê¸°
        setActiveSpecialNoteDropdown(null);
      };

      const toggleInputComplete = () => {
        if (isEditMode) {
          // ì…ë ¥ ì™„ë£Œ
          if (students.length === 0) {
            alert('í•™ìƒ ëª…ë ¬í‘œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            return;
          }
          if (categories.length === 0) {
            alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ íŠ¹ì„± ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            return;
          }
          setIsInputComplete(true);
          setIsEditMode(false);
          alert('ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          // ì…ë ¥ ìˆ˜ì •
          setIsEditMode(true);
        }
      };

      const handleStudentClickForSwap = (student, className) => {
        if (!isResultEditMode) {
          return;
        }

        const studentWithClass = { ...student, className };
        const existingIndex = selectedStudentsForSwap.findIndex(
          s => s.id === student.id && s.className === className
        );

        if (existingIndex > -1) {
          // ì´ë¯¸ ì„ íƒëœ í•™ìƒì´ë©´ ì„ íƒ í•´ì œ
          setSelectedStudentsForSwap(selectedStudentsForSwap.filter((_, i) => i !== existingIndex));
        } else if (selectedStudentsForSwap.length < 2) {
          // 2ëª… ë¯¸ë§Œì´ë©´ ì¶”ê°€
          setSelectedStudentsForSwap([...selectedStudentsForSwap, studentWithClass]);
        } else {
          // 2ëª… ì„ íƒëœ ìƒíƒœì—ì„œ ìƒˆë¡œìš´ í•™ìƒ ì„ íƒ ì‹œ ì²« ë²ˆì§¸ í•™ìƒ êµì²´
          setSelectedStudentsForSwap([selectedStudentsForSwap[1], studentWithClass]);
        }

        // 2ëª… ì„ íƒë˜ë©´ ìë™ìœ¼ë¡œ êµì²´
        if (selectedStudentsForSwap.length === 1) {
          const newSelected = [...selectedStudentsForSwap, studentWithClass];
          if (newSelected.length === 2) {
            swapStudents(newSelected[0], newSelected[1]);
          }
        }
      };

      const swapStudents = (student1, student2) => {
        if (student1.className === student2.className) {
          alert('ê°™ì€ ë°˜ì˜ í•™ìƒì€ êµì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          setSelectedStudentsForSwap([]);
          return;
        }

        const newResults = results.map(cls => {
          if (cls.name === student1.className) {
            // student1ì„ student2ë¡œ êµì²´
            return {
              ...cls,
              students: cls.students.map(s => s.id === student1.id ? student2 : s),
              maleCount: cls.students.filter(s => {
                if (s.id === student1.id) return student2.gender === 'ë‚¨ì„±' || student2.gender === 'ë‚¨' || student2.gender === 'M';
                return s.gender === 'ë‚¨ì„±' || s.gender === 'ë‚¨' || s.gender === 'M';
              }).length,
              femaleCount: cls.students.filter(s => {
                if (s.id === student1.id) return student2.gender === 'ì—¬ì„±' || student2.gender === 'ì—¬' || student2.gender === 'F';
                return s.gender === 'ì—¬ì„±' || s.gender === 'ì—¬' || s.gender === 'F';
              }).length
            };
          } else if (cls.name === student2.className) {
            // student2ë¥¼ student1ë¡œ êµì²´
            return {
              ...cls,
              students: cls.students.map(s => s.id === student2.id ? student1 : s),
              maleCount: cls.students.filter(s => {
                if (s.id === student2.id) return student1.gender === 'ë‚¨ì„±' || student1.gender === 'ë‚¨' || student1.gender === 'M';
                return s.gender === 'ë‚¨ì„±' || s.gender === 'ë‚¨' || s.gender === 'M';
              }).length,
              femaleCount: cls.students.filter(s => {
                if (s.id === student2.id) return student1.gender === 'ì—¬ì„±' || student1.gender === 'ì—¬' || student1.gender === 'F';
                return s.gender === 'ì—¬ì„±' || s.gender === 'ì—¬' || s.gender === 'F';
              }).length
            };
          }
          return cls;
        });

        setResults(newResults);
        setSelectedStudentsForSwap([]);
        alert(`${student1.name}ê³¼(ì™€) ${student2.name}ì˜ ë°˜ì´ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      };

      const moveStudentToClass = (student, targetClassName) => {
        const sourceClassName = student.className;
        
        if (sourceClassName === targetClassName) {
          alert('ì´ë¯¸ í•´ë‹¹ ë°˜ì— ì†í•´ ìˆìŠµë‹ˆë‹¤.');
          setSelectedStudentsForSwap([]);
          return;
        }

        const newResults = results.map(cls => {
          if (cls.name === sourceClassName) {
            // ì›ë˜ ë°˜ì—ì„œ í•™ìƒ ì œê±°
            const newStudents = cls.students.filter(s => s.id !== student.id);
            const isMale = student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M';
            
            return {
              ...cls,
              students: newStudents,
              maleCount: isMale ? cls.maleCount - 1 : cls.maleCount,
              femaleCount: !isMale ? cls.femaleCount - 1 : cls.femaleCount
            };
          } else if (cls.name === targetClassName) {
            // ëª©í‘œ ë°˜ì— í•™ìƒ ì¶”ê°€
            const isMale = student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M';
            
            return {
              ...cls,
              students: [...cls.students, student],
              maleCount: isMale ? cls.maleCount + 1 : cls.maleCount,
              femaleCount: !isMale ? cls.femaleCount + 1 : cls.femaleCount
            };
          }
          return cls;
        });

        setResults(newResults);
        setSelectedStudentsForSwap([]);
        alert(`${student.name} í•™ìƒì´ ${sourceClassName}ë°˜ì—ì„œ ${targetClassName}ë°˜ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      };

      const toggleResultSave = () => {
        if (!isResultSaved) {
          // ê²°ê³¼ ì €ì¥
          setIsResultSaved(true);
          setIsResultEditMode(false);
          setSelectedStudentsForSwap([]);
          alert('ë°˜í¸ì„± ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
      };

      const toggleResultEdit = () => {
        if (isResultSaved) {
          // ê²°ê³¼ ìˆ˜ì • ëª¨ë“œ ì‹œì‘
          setIsResultEditMode(true);
          setIsResultSaved(false);
          setSelectedStudentsForSwap([]);
        }
      };

      const removeCategory = (categoryId) => {
        setCategories(categories.filter(cat => cat.id !== categoryId));
        const newScores = { ...studentScores };
        Object.keys(newScores).forEach(studentId => {
          if (newScores[studentId]) {
            delete newScores[studentId][categoryId];
          }
        });
        setStudentScores(newScores);
      };

      const addSeparatePair = () => {
        if (newPair.student1 && newPair.student2 && newPair.student1 !== newPair.student2) {
          setSeparatePairs([...separatePairs, { ...newPair, id: Date.now() }]);
          setNewPair({ student1: '', student2: '' });
        }
      };

      const removePair = (pairId) => {
        setSeparatePairs(separatePairs.filter(pair => pair.id !== pairId));
      };

      const assignClasses = () => {
        if (students.length === 0) {
          alert('ë¨¼ì € í•™ìƒ ëª…ë ¬í‘œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
          return;
        }

        // ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
        const calculateCategoryScore = (studentId) => {
          if (!studentScores[studentId]) return 0;
          return Object.values(studentScores[studentId]).reduce((sum, score) => sum + score, 0);
        };

        // ë°˜ ì´ˆê¸°í™”
        const classes = Array.from({ length: numClasses }, (_, i) => ({
          name: String.fromCharCode(65 + i), // A, B, C...
          students: [],
          totalScore: 0,
          maleCount: 0,
          femaleCount: 0
        }));

        // ë‚¨ë…€ í•™ìƒ ë¶„ë¦¬ ë° ì ìˆ˜ ìˆœ ì •ë ¬ (ë†’ì€ ì ìˆ˜ -> ë‚®ì€ ì ìˆ˜)
        const maleStudents = students
          .filter(s => s.gender === 'ë‚¨ì„±' || s.gender === 'ë‚¨' || s.gender === 'M')
          .map(s => ({ ...s, score: calculateCategoryScore(s.id) }))
          .sort((a, b) => b.score - a.score);

        const femaleStudents = students
          .filter(s => s.gender === 'ì—¬ì„±' || s.gender === 'ì—¬' || s.gender === 'F')
          .map(s => ({ ...s, score: calculateCategoryScore(s.id) }))
          .sort((a, b) => b.score - a.score);

        // ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ ë°©ì‹ ë°°ì • í•¨ìˆ˜
        const snakeDraftAssign = (studentList, isMale) => {
          let classIndex = 0;
          let direction = 1; // 1: ì •ë°©í–¥, -1: ì—­ë°©í–¥

          for (let i = 0; i < studentList.length; i++) {
            const student = studentList[i];
            let assigned = false;
            let attempts = 0;

            // ê°™ì€ ë°˜ ê¸ˆì§€ í•™ìƒ ëª©ë¡
            const separateStudentIds = separatePairs
              .filter(pair => pair.student1 === student.name || pair.student2 === student.name)
              .map(pair => pair.student1 === student.name ? pair.student2 : pair.student1);

            // í˜„ì¬ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘í•´ì„œ ê°€ëŠ¥í•œ ë°˜ ì°¾ê¸°
            while (!assigned && attempts < numClasses) {
              const cls = classes[classIndex];

              // ê°™ì€ ë°˜ ê¸ˆì§€ í™•ì¸
              const hasSeparateStudent = cls.students.some(s => 
                separateStudentIds.includes(s.name)
              );

              if (!hasSeparateStudent) {
                cls.students.push(student);
                cls.totalScore += student.score;
                if (isMale) {
                  cls.maleCount++;
                } else {
                  cls.femaleCount++;
                }
                assigned = true;
              } else {
                // ê¸ˆì§€ í•™ìƒì´ ìˆìœ¼ë©´ ë‹¤ìŒ ë°˜ìœ¼ë¡œ
                classIndex += direction;
                if (classIndex >= numClasses) {
                  classIndex = numClasses - 1;
                  direction = -1;
                } else if (classIndex < 0) {
                  classIndex = 0;
                  direction = 1;
                }
                attempts++;
              }
            }

            // ê¸ˆì§€ ì¡°ê±´ ë•Œë¬¸ì— ë°°ì • ëª»í•œ ê²½ìš° í•™ìƒ ìˆ˜ê°€ ê°€ì¥ ì ì€ ë°˜ì— ë°°ì •
            if (!assigned) {
              const sortedByCount = [...classes].sort((a, b) => a.students.length - b.students.length);
              const lowestClass = sortedByCount[0];
              lowestClass.students.push(student);
              lowestClass.totalScore += student.score;
              if (isMale) {
                lowestClass.maleCount++;
              } else {
                lowestClass.femaleCount++;
              }
              assigned = true;
            }

            if (assigned) {
              // ë‹¤ìŒ ë°˜ìœ¼ë¡œ ì´ë™ (ìŠ¤ë„¤ì´í¬ íŒ¨í„´)
              classIndex += direction;
              
              // ëì— ë„ë‹¬í•˜ë©´ ë°©í–¥ ì „í™˜
              if (classIndex >= numClasses) {
                classIndex = numClasses - 1;
                direction = -1;
              } else if (classIndex < 0) {
                classIndex = 0;
                direction = 1;
              }
            }
          }
        };

        // 1ë‹¨ê³„: ë‚¨í•™ìƒì„ ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ë¡œ ê· ë“± ë°°ì¹˜
        snakeDraftAssign(maleStudents, true);
        
        // 2ë‹¨ê³„: ì—¬í•™ìƒì„ ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ë¡œ ê· ë“± ë°°ì¹˜
        snakeDraftAssign(femaleStudents, false);

        // 3ë‹¨ê³„: ìš´ë™ë¶€ í•™ìƒ ì¬ë°°ì¹˜ (ì„±ë¹„ ìœ ì§€í•˜ë©´ì„œ ê· ë“± ë¶„ë°°)
        const redistributeAthletes = () => {
          // ê° ë°˜ì˜ ìš´ë™ë¶€ í•™ìƒ ìˆ˜ ê³„ì‚°
          const athleteCounts = classes.map(cls => ({
            className: cls.name,
            count: cls.students.filter(s => studentSpecialNotes[s.id]?.includes('ìš´ë™ë¶€')).length
          }));

          // ìš´ë™ë¶€ í•™ìƒì´ ë§ì€ ë°˜ê³¼ ì ì€ ë°˜ ì°¾ê¸°
          let maxAthleteClass = athleteCounts.reduce((max, c) => c.count > max.count ? c : max);
          let minAthleteClass = athleteCounts.reduce((min, c) => c.count < min.count ? c : min);

          // ì°¨ì´ê°€ 2ëª… ì´ìƒì´ë©´ ì¬ë°°ì¹˜
          let attempts = 0;
          while (maxAthleteClass.count - minAthleteClass.count >= 2 && attempts < 20) {
            attempts++;
            
            const fromClass = classes.find(c => c.name === maxAthleteClass.className);
            const toClass = classes.find(c => c.name === minAthleteClass.className);
            
            // ìš´ë™ë¶€ í•™ìƒ ì¤‘ êµí™˜ ê°€ëŠ¥í•œ í•™ìƒ ì°¾ê¸°
            const fromAthletes = fromClass.students.filter(s => studentSpecialNotes[s.id]?.includes('ìš´ë™ë¶€'));
            const toNonAthletes = toClass.students.filter(s => !studentSpecialNotes[s.id]?.includes('ìš´ë™ë¶€'));
            
            let swapped = false;
            for (let athlete of fromAthletes) {
              // ê°™ì€ ì„±ë³„ì˜ ë¹„ìš´ë™ë¶€ í•™ìƒ ì°¾ê¸°
              const matchingNonAthlete = toNonAthletes.find(s => {
                const sameGender = (athlete.gender === 'ë‚¨ì„±' || athlete.gender === 'ë‚¨' || athlete.gender === 'M') === 
                                   (s.gender === 'ë‚¨ì„±' || s.gender === 'ë‚¨' || s.gender === 'M');
                
                // ê°™ì€ ë°˜ ê¸ˆì§€ í™•ì¸
                const athleteSeparate = separatePairs
                  .filter(pair => pair.student1 === athlete.name || pair.student2 === athlete.name)
                  .map(pair => pair.student1 === athlete.name ? pair.student2 : pair.student1);
                
                const nonAthleteSeparate = separatePairs
                  .filter(pair => pair.student1 === s.name || pair.student2 === s.name)
                  .map(pair => pair.student1 === s.name ? pair.student2 : pair.student1);
                
                const athleteCanMove = !toClass.students.some(st => athleteSeparate.includes(st.name));
                const nonAthleteCanMove = !fromClass.students.some(st => nonAthleteSeparate.includes(st.name));
                
                return sameGender && athleteCanMove && nonAthleteCanMove;
              });
              
              if (matchingNonAthlete) {
                // ë‘ í•™ìƒ êµí™˜
                const athleteIdx = fromClass.students.findIndex(s => s.id === athlete.id);
                const nonAthleteIdx = toClass.students.findIndex(s => s.id === matchingNonAthlete.id);
                
                fromClass.students[athleteIdx] = matchingNonAthlete;
                toClass.students[nonAthleteIdx] = athlete;
                
                // ì ìˆ˜ ì¡°ì •
                fromClass.totalScore = fromClass.totalScore - athlete.score + matchingNonAthlete.score;
                toClass.totalScore = toClass.totalScore - matchingNonAthlete.score + athlete.score;
                
                swapped = true;
                break;
              }
            }
            
            if (!swapped) break;
            
            // ìš´ë™ë¶€ ì¹´ìš´íŠ¸ ì¬ê³„ì‚°
            athleteCounts.forEach(ac => {
              const cls = classes.find(c => c.name === ac.className);
              ac.count = cls.students.filter(s => studentSpecialNotes[s.id]?.includes('ìš´ë™ë¶€')).length;
            });
            
            maxAthleteClass = athleteCounts.reduce((max, c) => c.count > max.count ? c : max);
            minAthleteClass = athleteCounts.reduce((min, c) => c.count < min.count ? c : min);
          }
        };
        

        // ê° ë°˜ì˜ í•™ìƒ ìˆ˜ê°€ ê· ë“±í•œì§€ í™•ì¸ ë° ì¬ì¡°ì •
        const avgStudentsPerClass = students.length / numClasses;
        const maxDifference = 2; // ìµœëŒ€ í•™ìƒ ìˆ˜ ì°¨ì´

        // í•™ìƒ ìˆ˜ ê· ë“±í™” (í•„ìš”ì‹œ)
        let needsBalancing = true;
        let balanceAttempts = 0;
        const maxBalanceAttempts = 10;

        while (needsBalancing && balanceAttempts < maxBalanceAttempts) {
          needsBalancing = false;
          balanceAttempts++;

          const sortedBySize = [...classes].sort((a, b) => b.students.length - a.students.length);
          const largest = sortedBySize[0];
          const smallest = sortedBySize[sortedBySize.length - 1];

          if (largest.students.length - smallest.students.length > maxDifference) {
            // ê°€ì¥ í° ë°˜ì—ì„œ ê°€ì¥ ì‘ì€ ë°˜ìœ¼ë¡œ í•™ìƒ ì´ë™
            for (let i = largest.students.length - 1; i >= 0; i--) {
              const student = largest.students[i];
              
              // ê°™ì€ ë°˜ ê¸ˆì§€ í™•ì¸
              const separateStudentIds = separatePairs
                .filter(pair => pair.student1 === student.name || pair.student2 === student.name)
                .map(pair => pair.student1 === student.name ? pair.student2 : pair.student1);
              
              const hasSeparateStudent = smallest.students.some(s => 
                separateStudentIds.includes(s.name)
              );

              if (!hasSeparateStudent) {
                // í•™ìƒ ì´ë™
                largest.students.splice(i, 1);
                smallest.students.push(student);
                
                // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                if (student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M') {
                  largest.maleCount--;
                  smallest.maleCount++;
                } else {
                  largest.femaleCount--;
                  smallest.femaleCount++;
                }
                
                largest.totalScore -= student.score;
                smallest.totalScore += student.score;
                
                needsBalancing = true;
                break;
              }
            }
          }
        }

        setResults(classes);
        setIsResultSaved(false);
        setIsResultEditMode(true);
        setSelectedStudentsForSwap([]);
        setNameSortOrder(null);
        setGenderSortOrder(null);
      };

      // ì´ë¦„ìˆœ ì •ë ¬ í•¨ìˆ˜
      const toggleNameSort = () => {
        if (!results) return;

        const newSortOrder = nameSortOrder === 'asc' ? 'desc' : 'asc';
        setNameSortOrder(newSortOrder);
        setGenderSortOrder(null);

        const sortedResults = results.map(cls => ({
          ...cls,
          students: [...cls.students].sort((a, b) => {
            if (newSortOrder === 'asc') {
              return a.name.localeCompare(b.name, 'ko');
            } else {
              return b.name.localeCompare(a.name, 'ko');
            }
          })
        }));

        setResults(sortedResults);
      };

      // ì„±ë³„ìˆœ ì •ë ¬ í•¨ìˆ˜
      const toggleGenderSort = () => {
        if (!results) return;

        const newSortOrder = genderSortOrder === 'male-first' ? 'female-first' : 'male-first';
        setGenderSortOrder(newSortOrder);
        setNameSortOrder(null);

        const sortedResults = results.map(cls => ({
          ...cls,
          students: [...cls.students].sort((a, b) => {
            const aIsMale = a.gender === 'ë‚¨ì„±' || a.gender === 'ë‚¨' || a.gender === 'M';
            const bIsMale = b.gender === 'ë‚¨ì„±' || b.gender === 'ë‚¨' || b.gender === 'M';

            if (newSortOrder === 'male-first') {
              if (aIsMale && !bIsMale) return -1;
              if (!aIsMale && bIsMale) return 1;
              return a.name.localeCompare(b.name, 'ko');
            } else {
              if (!aIsMale && bIsMale) return -1;
              if (aIsMale && !bIsMale) return 1;
              return a.name.localeCompare(b.name, 'ko');
            }
          })
        }));

        setResults(sortedResults);
      };

      const downloadExcel = () => {
        if (!results) {
          alert('ë¨¼ì € ë°˜í¸ì„±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
          return;
        }

        // ì›ë³¸ ì‹œíŠ¸ ë°ì´í„° ìƒì„±
        const originalData = [];
        results.forEach(cls => {
          cls.students.forEach(student => {
            originalData.push({
              'í•™ìƒê°œì¸ë²ˆí˜¸': student.studentId || '',
              'í•™ë…„': student.grade || '',
              'ë°˜': student.originalClass || '',
              'ë²ˆí˜¸': student.number || '',
              'ì´ë¦„': student.name,
              'ì„±ë³„': student.gender,
              'ìƒë…„ì›”ì¼': student.birthDate || '',
              'íŠ¹ì´ì‚¬í•­': studentSpecialNotes[student.id]?.join(', ') || student.specialNote || '',
              'ì›ë˜ë°˜': student.originalClass || '',
              'ë°°ì •ë°˜': cls.name + 'ë°˜'
            });
          });
        });

        // ì›ë³¸ ì‹œíŠ¸ ìƒì„±
        const originalSheet = XLSX.utils.json_to_sheet(originalData);

        // ì›Œí¬ë¶ ìƒì„±
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, originalSheet, 'ì›ë³¸');

        // ê° ë°˜ë³„ ì‹œíŠ¸ ìƒì„±
        results.forEach(cls => {
          const classData = cls.students.map(student => ({
            'í•™ìƒê°œì¸ë²ˆí˜¸': student.studentId || '',
            'í•™ë…„': student.grade || '',
            'ë°˜': student.originalClass || '',
            'ë²ˆí˜¸': student.number || '',
            'ì´ë¦„': student.name,
            'ì„±ë³„': student.gender,
            'ìƒë…„ì›”ì¼': student.birthDate || '',
            'íŠ¹ì´ì‚¬í•­': studentSpecialNotes[student.id]?.join(', ') || student.specialNote || '',
            'ì›ë˜ë°˜': student.originalClass || ''
          }));
          
          const classSheet = XLSX.utils.json_to_sheet(classData);
          XLSX.utils.book_append_sheet(workbook, classSheet, cls.name + 'ë°˜');
        });

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const fileName = `ë°˜í¸ì„±_ê²°ê³¼_${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      };

      return (
        <div 
          className="main-container"
          style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            padding: '2rem',
            fontFamily: "'Noto Sans KR', -apple-system, sans-serif"
          }}
          onClick={() => {
            setActiveScoreDropdown(null);
            setActiveSpecialNoteDropdown(null);
          }}
        >
          {/* ë¹„ë°€ë²ˆí˜¸ ì„¤ì •/í™•ì¸ ëª¨ë‹¬ */}
          {!isUnlocked && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.7)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999
            }}>
              <div style={{
                background: 'white',
                borderRadius: '16px',
                padding: '2.5rem',
                maxWidth: '400px',
                width: '90%',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
              }}>
                <h2 style={{
                  margin: '0 0 1.5rem 0',
                  color: '#333',
                  fontSize: '1.5rem',
                  textAlign: 'center'
                }}>
                  {isPasswordSet ? 'ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥' : 'ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •'}
                </h2>
                
                <p style={{
                  color: '#666',
                  fontSize: '0.9rem',
                  textAlign: 'center',
                  marginBottom: '1.5rem',
                  lineHeight: '1.6'
                }}>
                  {isPasswordSet 
                    ? 'ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.' 
                    : <>ë°ì´í„° ë³´í˜¸ë¥¼ ìœ„í•´<br/>4ìë¦¬ ìˆ«ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</>}
                </p>
                
                <input
                  type="password"
                  maxLength="4"
                  value={isPasswordSet ? inputPassword : password}
                  onChange={(e) => {
                    const value = e.target.value.replace(/\D/g, '');
                    if (isPasswordSet) {
                      setInputPassword(value);
                    } else {
                      setPassword(value);
                    }
                  }}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      if (isPasswordSet) {
                        checkPassword();
                      } else if (password.length === 4) {
                        setNewPassword(password);
                      }
                    }
                  }}
                  placeholder="4ìë¦¬ ìˆ«ì"
                  style={{
                    width: '100%',
                    padding: '1rem',
                    fontSize: '1.5rem',
                    textAlign: 'center',
                    border: '2px solid #ddd',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    letterSpacing: '0.5rem'
                  }}
                />
                
                <button
                  onClick={() => {
                    if (isPasswordSet) {
                      checkPassword();
                    } else {
                      setNewPassword(password);
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '1rem',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '1rem',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'transform 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.transform = 'scale(1.02)'}
                  onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                >
                  {isPasswordSet ? 'í™•ì¸' : 'ì„¤ì •'}
                </button>
                
                {isPasswordSet && (
                  <div
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      background: 'transparent',
                      color: '#ff6b6b',
                      border: 'none',
                      fontSize: '0.85rem',
                      marginTop: '0.5rem',
                      textAlign: 'center',
                      fontWeight: '600',
                      lineHeight: '1.6'
                    }}
                  >
                    âš ï¸ ë¹„ë°€ë²ˆí˜¸ 5íšŒ í‹€ë¦¬ë©´<br/>ì €ì¥ëœ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
                  </div>
                )}
              </div>
            </div>
          )}

          {/* ë©”ì¸ ì»¨í…Œì´ë„ˆ ë˜í¼ */}
          <div style={{
            maxWidth: '1400px',
            margin: '0 auto',
            position: 'relative'
          }}>
            <div 
              style={{
                background: 'rgba(255, 255, 255, 0.98)',
                borderRadius: '24px',
                boxShadow: '0 25px 50px rgba(0, 0, 0, 0.25)',
                overflow: 'hidden',
                opacity: isUnlocked ? 1 : 0.3,
                pointerEvents: isUnlocked ? 'auto' : 'none'
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* í—¤ë” */}
              <div style={{
                background: 'linear-gradient(135deg, #5f72e4 0%, #6d5ca6 100%)',
                padding: '3rem 2rem',
                position: 'relative',
                overflow: 'hidden',
              textAlign: 'center'
            }}>
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%)',
                pointerEvents: 'none'
              }}></div>
              
              <h1 style={{
                fontSize: '2.5rem',
                fontWeight: '800',
                color: 'white',
                margin: 0,
                letterSpacing: '-0.5px',
                position: 'relative'
              }}>ë°˜í¸ì„± í”„ë¡œê·¸ë¨ (í•™ê¸‰ìš©)</h1>
              <p className="subtitle" style={{
                color: 'rgba(255, 255, 255, 0.9)',
                fontSize: '1rem',
                marginTop: '0.5rem',
                position: 'relative'
              }}>í•™ìƒ íŠ¹ì„±ì„ ê³ ë ¤í•œ ê· í˜•ì¡íŒ ë°˜í¸ì„±</p>
              
              {/* ì´ˆê¸°í™” ë²„íŠ¼ (í—¤ë” ì•ˆìª½ í•˜ë‹¨ ì˜¤ë¥¸ìª½) */}
              {isUnlocked && (
                <div style={{
                  display: 'flex',
                  justifyContent: 'flex-end',
                  paddingTop: '1.5rem',
                  position: 'relative'
                }}>
                  <button
                    onClick={resetAll}
                    style={{
                      padding: '0.6rem 1.2rem',
                      background: 'white',
                      color: '#667eea',
                      border: '2px solid #e0e0e0',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      fontWeight: '600',
                      fontSize: '0.85rem',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.4rem',
                      transition: 'all 0.2s',
                      boxShadow: '0 2px 6px rgba(0, 0, 0, 0.1)'
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.background = '#f8f9fa';
                      e.target.style.transform = 'scale(1.05)';
                      e.target.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.background = 'white';
                      e.target.style.transform = 'scale(1)';
                      e.target.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.1)';
                    }}
                  >
                    ğŸ”„ ì´ˆê¸°í™”
                  </button>
                </div>
              )}
            </div>

            <div style={{ padding: '2rem' }}>
              {/* ì„¤ì • ì„¹ì…˜ */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                gap: '1.5rem',
                marginBottom: '2rem'
              }}>
                {/* íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ */}
                <div style={{
                  background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  color: 'white',
                  boxShadow: '0 10px 30px rgba(240, 147, 251, 0.3)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                    <Upload />
                    <h3 style={{ margin: '0 0 0 0.5rem', fontSize: '1.2rem', fontWeight: '700' }}>
                      í•™ìƒ ëª…ë ¬í‘œ ì—…ë¡œë“œ
                    </h3>
                  </div>
                  <div className="upload-container" style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem' }}>
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      onChange={handleFileUpload}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        color: '#333',
                        fontWeight: '500'
                      }}
                    />
                    <button
                      onClick={downloadTemplate}
                      className="desktop-template-btn"
                      style={{
                        padding: '0.75rem 1.25rem',
                        background: 'white',
                        color: '#f5576c',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '0.9rem',
                        whiteSpace: 'nowrap',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem'
                      }}
                    >
                      <Download />
                      ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                    </button>
                  </div>
                  
                  {/* ìŠ¤ë§ˆíŠ¸í°ìš© ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (í•™ìƒ ë¡œë“œ ì „) */}
                  {students.length === 0 && (
                    <button
                      onClick={downloadTemplate}
                      className="mobile-template-btn-before"
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        background: 'rgba(255, 255, 255, 0.3)',
                        color: 'white',
                        border: '1px solid rgba(255, 255, 255, 0.5)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '0.9rem',
                        display: 'none',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.5rem',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.target.style.background = 'rgba(255, 255, 255, 0.4)';
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.background = 'rgba(255, 255, 255, 0.3)';
                      }}
                    >
                      <Download style={{ width: '16px', height: '16px' }} />
                      ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                    </button>
                  )}
                  
                  {students.length > 0 && (
                    <div style={{ 
                      marginTop: '1rem',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <p style={{ 
                        fontSize: '0.9rem', 
                        opacity: 0.95,
                        margin: 0,
                        flex: 1,
                        minWidth: 0
                      }}>
                        âœ“ {students.length}ëª…ì˜ í•™ìƒ ë¡œë“œë¨
                      </p>
                      
                      <div style={{
                        display: 'flex',
                        gap: '0.5rem',
                        flexShrink: 0
                      }}>
                        {/* ì‚­ì œ ë²„íŠ¼ */}
                        <button
                          onClick={clearStudentData}
                          style={{
                            padding: '0.5rem 0.75rem',
                            background: 'linear-gradient(135deg, #FFB6C1 0%, #FFB3D9 100%)',
                            color: '#8B4789',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontWeight: '600',
                            fontSize: '0.75rem',
                            whiteSpace: 'nowrap',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.3rem',
                            transition: 'all 0.2s',
                            flexShrink: 0,
                            boxShadow: '0 2px 6px rgba(255, 182, 193, 0.3)'
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.background = 'linear-gradient(135deg, #FFA0B4 0%, #FFA3CC 100%)';
                            e.target.style.transform = 'scale(1.05)';
                            e.target.style.boxShadow = '0 4px 12px rgba(255, 182, 193, 0.5)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.background = 'linear-gradient(135deg, #FFB6C1 0%, #FFB3D9 100%)';
                            e.target.style.transform = 'scale(1)';
                            e.target.style.boxShadow = '0 2px 6px rgba(255, 182, 193, 0.3)';
                          }}
                        >
                          ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                        
                        {/* ìŠ¤ë§ˆíŠ¸í°ìš© ì‘ì€ ì–‘ì‹ ë²„íŠ¼ (í•™ìƒ ë¡œë“œ í›„) */}
                        <button
                          onClick={downloadTemplate}
                          className="mobile-template-btn-after"
                          style={{
                            padding: '0.5rem 0.75rem',
                            background: 'rgba(255, 255, 255, 0.3)',
                            color: 'white',
                            border: '1px solid rgba(255, 255, 255, 0.5)',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontWeight: '600',
                            fontSize: '0.75rem',
                            whiteSpace: 'nowrap',
                            display: 'none',
                            alignItems: 'center',
                            gap: '0.3rem',
                            transition: 'all 0.2s',
                            flexShrink: 0
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(255, 255, 255, 0.4)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.background = 'rgba(255, 255, 255, 0.3)';
                          }}
                        >
                          <Download style={{ width: '14px', height: '14px' }} />
                          ì–‘ì‹
                        </button>
                      </div>
                    </div>
                  )}
                </div>

                {/* í•™ê¸‰ ìˆ˜ ì„¤ì • ì¹´ë“œ */}
                <div style={{
                  background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  color: 'white',
                  boxShadow: '0 10px 30px rgba(79, 172, 254, 0.3)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                    <Settings />
                    <h3 style={{ margin: '0 0 0 0.5rem', fontSize: '1.2rem', fontWeight: '700' }}>
                      í•™ê¸‰ ìˆ˜ ì„¤ì •
                    </h3>
                  </div>
                  <button
                    onClick={() => setShowClassModal(true)}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      background: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#333',
                      cursor: 'pointer',
                      textAlign: 'left',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}
                  >
                    <span>{numClasses}ê°œ í•™ê¸‰</span>
                    <span style={{ fontSize: '1.2rem' }}>â–¼</span>
                  </button>
                  <p style={{ marginTop: '1rem', fontSize: '0.9rem', opacity: 0.95 }}>
                    í•™ê¸‰ë‹¹ ì•½ {students.length > 0 ? Math.ceil(students.length / numClasses) : 0}ëª…
                  </p>
                </div>
              </div>

              {/* ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ */}
              <div style={{
                background: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                borderRadius: '16px',
                padding: '2rem',
                marginBottom: '2rem',
                boxShadow: '0 10px 30px rgba(252, 182, 159, 0.3)'
              }}>
                <h3 style={{
                  fontSize: '1.3rem',
                  fontWeight: '700',
                  marginBottom: '1.5rem',
                  color: '#8b4513',
                  display: 'flex',
                  alignItems: 'center'
                }}>
                  <Plus />
                  <span style={{ marginLeft: '0.5rem' }}>í•™ìƒ íŠ¹ì„± ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</span>
                </h3>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <button
                    onClick={() => setShowCategoryModal(true)}
                    style={{
                      width: '100%',
                      padding: '1rem 1.5rem',
                      background: '#8b4513',
                      color: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '0.5rem'
                    }}
                  >
                    <Plus />
                    <span>íŠ¹ì„± ì¹´í…Œê³ ë¦¬ ì¶”ê°€í•˜ê¸°</span>
                  </button>
                </div>

                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.75rem' }}>
                  {categories.map(cat => (
                    <div
                      key={cat.id}
                      style={{
                        background: 'white',
                        padding: '0.5rem 1rem',
                        borderRadius: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                        fontWeight: '500',
                        color: '#8b4513'
                      }}
                    >
                      {cat.name}
                      <button
                        onClick={() => removeCategory(cat.id)}
                        style={{
                          background: 'none',
                          border: 'none',
                          color: '#f5576c',
                          cursor: 'pointer',
                          padding: '0',
                          display: 'flex',
                          alignItems: 'center'
                        }}
                      >
                        <X />
                      </button>
                    </div>
                  ))}
                </div>
                {categories.length === 0 && (
                  <p style={{ 
                    textAlign: 'center', 
                    color: '#8b4513', 
                    marginTop: '1rem',
                    opacity: 0.8
                  }}>
                    ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
                  </p>
                )}
              </div>

              {/* í•™ìƒ ëª©ë¡ */}
              {students.length > 0 && (
                <div style={{
                  background: 'white',
                  borderRadius: '16px',
                  padding: '2rem',
                  marginBottom: '2rem',
                  border: '2px solid #e0e0e0'
                }}>
                  <h3 style={{
                    fontSize: '1.3rem',
                    fontWeight: '700',
                    marginBottom: '1.5rem',
                    color: '#333',
                    display: 'flex',
                    alignItems: 'center'
                  }}>
                    <Users />
                    <span style={{ marginLeft: '0.5rem' }}>í•™ìƒ ëª©ë¡ ë° íŠ¹ì„± ì ìˆ˜</span>
                  </h3>

                  <div style={{ 
                    overflowX: 'auto',
                    maxHeight: '600px',
                    overflowY: 'auto',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    position: 'relative',
                    WebkitOverflowScrolling: 'touch'
                  }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ background: '#f5f5f5' }}>
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'left', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10
                          }}>ì´ë¦„</th>
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'center', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10
                          }}>ì„±ë³„</th>
                          {categories.map(cat => (
                            <th key={cat.id} style={{ 
                              padding: '0.75rem 0.5rem', 
                              textAlign: 'center', 
                              fontWeight: '600',
                              fontSize: '0.9rem',
                              position: 'sticky',
                              top: 0,
                              background: '#f5f5f5',
                              zIndex: 10,
                              whiteSpace: 'nowrap'
                            }}>
                              {cat.name}
                            </th>
                          ))}
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'center', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10,
                            whiteSpace: 'nowrap'
                          }}>íŠ¹ì´ì‚¬í•­</th>
                        </tr>
                      </thead>
                      <tbody>
                        {students.map((student, idx) => (
                          <tr
                            key={student.id}
                            style={{
                              borderBottom: '1px solid #e0e0e0',
                              background: idx % 2 === 0 ? 'white' : '#fafafa'
                            }}
                          >
                            <td style={{ padding: '0.75rem 0.5rem', fontWeight: '500', fontSize: '0.9rem' }}>{student.name}</td>
                            <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                              <span style={{
                                padding: '0.2rem 0.5rem',
                                borderRadius: '8px',
                                background: student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? '#e3f2fd' : '#fce4ec',
                                color: student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? '#1976d2' : '#c2185b',
                                fontWeight: '600',
                                fontSize: '0.8rem'
                              }}>
                                {student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}
                              </span>
                            </td>
                            {categories.map(cat => {
                              const dropdownKey = `${student.id}-${cat.id}`;
                              const isDropdownActive = activeScoreDropdown === dropdownKey;
                              const currentScore = studentScores[student.id]?.[cat.id];
                              
                              return (
                                <td 
                                  key={cat.id} 
                                  style={{ 
                                    padding: '0.5rem 0.25rem', 
                                    textAlign: 'center',
                                    position: 'relative'
                                  }}
                                >
                                  <div
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      toggleScoreDropdown(student.id, cat.id);
                                    }}
                                    style={{
                                      display: 'inline-block',
                                      minWidth: '35px',
                                      padding: '0.4rem 0.6rem',
                                      fontSize: '0.95rem',
                                      fontWeight: '600',
                                      color: currentScore ? '#667eea' : '#ccc',
                                      border: currentScore ? '2px solid #667eea' : '2px solid #e0e0e0',
                                      borderRadius: '6px',
                                      background: 'white',
                                      cursor: isEditMode ? 'pointer' : 'default',
                                      transition: 'all 0.2s',
                                      position: 'relative',
                                      zIndex: isDropdownActive ? 200 : 1
                                    }}
                                  >
                                    {currentScore || '-'}
                                    
                                    {isDropdownActive && (
                                      <div
                                        style={{
                                          position: 'absolute',
                                          top: 'calc(100% + 0.5rem)',
                                          left: '50%',
                                          transform: 'translateX(-50%)',
                                          background: 'white',
                                          borderRadius: '10px',
                                          boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
                                          padding: '0.4rem',
                                          zIndex: 1000,
                                          display: 'flex',
                                          gap: '0.4rem',
                                          whiteSpace: 'nowrap'
                                        }}
                                        onClick={(e) => e.stopPropagation()}
                                      >
                                        {[5, 4, 3, 2, 1].map(score => (
                                          <button
                                            key={score}
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              selectScore(student.id, cat.id, score);
                                            }}
                                            style={{
                                              width: '40px',
                                              height: '40px',
                                              background: currentScore === score
                                                ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                                : '#f5f5f5',
                                              color: currentScore === score ? 'white' : '#333',
                                              border: 'none',
                                              borderRadius: '8px',
                                              cursor: 'pointer',
                                              fontWeight: '700',
                                              fontSize: '1.1rem',
                                              transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentScore !== score) {
                                                e.target.style.background = '#e0e0e0';
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentScore !== score) {
                                                e.target.style.background = '#f5f5f5';
                                              }
                                            }}
                                          >
                                            {score}
                                          </button>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </td>
                              );
                            })}
                            
                            {/* íŠ¹ì´ì‚¬í•­ ì…€ */}
                            <td 
                              style={{ 
                                padding: '0.5rem 0.25rem', 
                                textAlign: 'center',
                                position: 'relative'
                              }}
                            >
                              <div
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (isEditMode) {
                                    toggleSpecialNoteDropdown(student.id);
                                  } else {
                                    alert('ì…ë ¥ ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜í•´ì£¼ì„¸ìš”.');
                                  }
                                }}
                                id={`special-note-btn-${student.id}`}
                                style={{
                                  display: 'inline-block',
                                  minWidth: '80px',
                                  maxWidth: '140px',
                                  padding: '0.6rem 0.9rem',
                                  fontSize: '0.9rem',
                                  fontWeight: '600',
                                  color: studentSpecialNotes[student.id]?.length > 0 ? 'white' : '#666',
                                  border: '2px solid #e67e22',
                                  borderRadius: '8px',
                                  background: studentSpecialNotes[student.id]?.length > 0 
                                    ? 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)'
                                    : 'white',
                                  cursor: isEditMode ? 'pointer' : 'not-allowed',
                                  transition: 'all 0.2s',
                                  whiteSpace: 'nowrap',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  position: 'relative',
                                  boxShadow: isEditMode ? '0 2px 4px rgba(0, 0, 0, 0.1)' : 'none'
                                }}
                                onMouseEnter={(e) => {
                                  if (isEditMode) {
                                    e.currentTarget.style.transform = 'scale(1.05)';
                                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(230, 126, 34, 0.3)';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (isEditMode) {
                                    e.currentTarget.style.transform = 'scale(1)';
                                    e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                                  }
                                }}
                              >
                                {studentSpecialNotes[student.id]?.length > 0 
                                  ? studentSpecialNotes[student.id].join(', ') 
                                  : 'ì„ íƒ'}
                              </div>
                              
                              {activeSpecialNoteDropdown === student.id && (
                                <div
                                  style={{
                                    position: 'fixed',
                                    top: (() => {
                                      const btn = document.getElementById(`special-note-btn-${student.id}`);
                                      if (btn) {
                                        const rect = btn.getBoundingClientRect();
                                        return `${rect.bottom + 8}px`;
                                      }
                                      return '50%';
                                    })(),
                                    left: (() => {
                                      const btn = document.getElementById(`special-note-btn-${student.id}`);
                                      if (btn) {
                                        const rect = btn.getBoundingClientRect();
                                        return `${rect.left + rect.width / 2}px`;
                                      }
                                      return '50%';
                                    })(),
                                    transform: 'translateX(-50%)',
                                    background: 'white',
                                    borderRadius: '12px',
                                    boxShadow: '0 15px 40px rgba(0, 0, 0, 0.35)',
                                    padding: '0.75rem',
                                    zIndex: 3000,
                                    minWidth: '160px',
                                    border: '3px solid #e67e22'
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  <div style={{
                                    fontSize: '0.85rem',
                                    fontWeight: '700',
                                    color: '#e67e22',
                                    marginBottom: '0.6rem',
                                    textAlign: 'center',
                                    borderBottom: '2px solid #e67e22',
                                    paddingBottom: '0.5rem'
                                  }}>
                                    ğŸ“‹ íŠ¹ì´ì‚¬í•­ ì„ íƒ
                                  </div>
                                  {specialNoteOptions.map((note, noteIdx) => {
                                    const isSelected = studentSpecialNotes[student.id]?.includes(note);
                                    return (
                                      <div
                                        key={note}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          toggleSpecialNote(student.id, note);
                                        }}
                                        style={{
                                          padding: '0.8rem 1rem',
                                          background: isSelected ? '#e67e22' : '#f8f8f8',
                                          color: isSelected ? 'white' : '#333',
                                          borderRadius: '8px',
                                          cursor: 'pointer',
                                          marginBottom: noteIdx < specialNoteOptions.length - 1 ? '0.5rem' : '0',
                                          fontWeight: isSelected ? '700' : '600',
                                          fontSize: '1rem',
                                          transition: 'all 0.2s',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '0.7rem',
                                          userSelect: 'none',
                                          border: isSelected ? '2px solid #d35400' : '2px solid transparent'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (!isSelected) {
                                            e.currentTarget.style.background = '#e0e0e0';
                                            e.currentTarget.style.transform = 'scale(1.03)';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (!isSelected) {
                                            e.currentTarget.style.background = '#f8f8f8';
                                            e.currentTarget.style.transform = 'scale(1)';
                                          }
                                        }}
                                      >
                                        <span style={{ 
                                          width: '24px',
                                          height: '24px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontWeight: '900',
                                          fontSize: '1.3rem',
                                          background: isSelected ? 'rgba(255, 255, 255, 0.3)' : '#ddd',
                                          borderRadius: '6px'
                                        }}>
                                          {isSelected ? 'âœ“' : ''}
                                        </span>
                                        <span style={{ flex: 1 }}>{note}</span>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* ê°™ì€ ë°˜ ê¸ˆì§€ í•™ìƒ */}
              {students.length > 0 && (
                <div style={{
                  background: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  marginBottom: '2rem',
                  boxShadow: '0 10px 30px rgba(255, 154, 158, 0.3)'
                }}>
                  <h3 style={{
                    fontSize: '1.3rem',
                    fontWeight: '700',
                    marginBottom: '1.5rem',
                    color: '#c2185b'
                  }}>
                    ê°™ì€ ë°˜ ê¸ˆì§€ í•™ìƒ ì„¤ì •
                  </h3>

                  <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                    <select
                      value={newPair.student1}
                      onChange={(e) => setNewPair({ ...newPair, student1: e.target.value })}
                      style={{
                        flex: 1,
                        minWidth: '200px',
                        padding: '0.75rem',
                        border: '2px solid rgba(194, 24, 91, 0.2)',
                        borderRadius: '12px',
                        fontSize: '1rem',
                        background: 'white'
                      }}
                    >
                      <option value="">í•™ìƒ ì„ íƒ</option>
                      {students.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>

                    <select
                      value={newPair.student2}
                      onChange={(e) => setNewPair({ ...newPair, student2: e.target.value })}
                      style={{
                        flex: 1,
                        minWidth: '200px',
                        padding: '0.75rem',
                        border: '2px solid rgba(194, 24, 91, 0.2)',
                        borderRadius: '12px',
                        fontSize: '1rem',
                        background: 'white'
                      }}
                    >
                      <option value="">í•™ìƒ ì„ íƒ</option>
                      {students.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>

                    <button
                      onClick={addSeparatePair}
                      style={{
                        padding: '0.75rem 2rem',
                        background: '#c2185b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap'
                      }}
                    >
                      ì¶”ê°€
                    </button>
                  </div>

                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.75rem' }}>
                    {separatePairs.map(pair => (
                      <div
                        key={pair.id}
                        style={{
                          background: 'white',
                          padding: '0.5rem 1rem',
                          borderRadius: '20px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                          fontWeight: '500',
                          color: '#c2185b'
                        }}
                      >
                        {pair.student1} â†” {pair.student2}
                        <button
                          onClick={() => removePair(pair.id)}
                          style={{
                            background: 'none',
                            border: 'none',
                            color: '#f5576c',
                            cursor: 'pointer',
                            padding: '0',
                            display: 'flex',
                            alignItems: 'center'
                          }}
                        >
                          <Trash2 />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ì…ë ¥ì™„ë£Œ & ë°˜í¸ì„± ì‹¤í–‰ ë²„íŠ¼ */}
              {students.length > 0 && (
                <div style={{ 
                  display: 'flex', 
                  gap: '1.5rem', 
                  justifyContent: 'center',
                  marginBottom: '2rem',
                  flexWrap: 'wrap'
                }}>
                  <button
                    onClick={toggleInputComplete}
                    style={{
                      padding: '1.25rem 3rem',
                      background: isEditMode 
                        ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)'
                        : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '16px',
                      fontSize: '1.2rem',
                      fontWeight: '700',
                      cursor: 'pointer',
                      boxShadow: isEditMode
                        ? '0 10px 30px rgba(17, 153, 142, 0.4)'
                        : '0 10px 30px rgba(240, 147, 251, 0.4)',
                      transition: 'transform 0.2s',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      minWidth: '200px',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                    onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                  >
                    <Check />
                    {isEditMode ? 'ì…ë ¥ ì™„ë£Œ' : 'ì…ë ¥ ìˆ˜ì •'}
                  </button>

                  <button
                    onClick={assignClasses}
                    disabled={!isInputComplete}
                    style={{
                      padding: '1.25rem 3rem',
                      background: isInputComplete
                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                        : '#ccc',
                      color: 'white',
                      border: 'none',
                      borderRadius: '16px',
                      fontSize: '1.2rem',
                      fontWeight: '700',
                      cursor: isInputComplete ? 'pointer' : 'not-allowed',
                      boxShadow: isInputComplete
                        ? '0 10px 30px rgba(102, 126, 234, 0.4)'
                        : 'none',
                      transition: 'transform 0.2s',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      minWidth: '200px',
                      justifyContent: 'center',
                      opacity: isInputComplete ? 1 : 0.6
                    }}
                    onMouseEnter={(e) => {
                      if (isInputComplete) {
                        e.target.style.transform = 'scale(1.05)';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.transform = 'scale(1)';
                    }}
                  >
                    <Play />
                    ë°˜í¸ì„± ì‹¤í–‰í•˜ê¸°
                  </button>
                </div>
              )}

              {/* ê²°ê³¼ í‘œì‹œ */}
              {results && (
                <div>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '1.5rem',
                    flexWrap: 'wrap',
                    gap: '1rem'
                  }}>
                    <h3 style={{
                      fontSize: '1.5rem',
                      fontWeight: '700',
                      color: '#333',
                      margin: 0
                    }}>
                      ë°˜í¸ì„± ê²°ê³¼
                    </h3>
                    
                    <div style={{ 
                      display: 'flex', 
                      gap: '0.75rem',
                      flexWrap: 'wrap',
                      alignItems: 'center'
                    }}>
                      {/* ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬ ë²„íŠ¼ */}
                      <button
                        onClick={toggleNameSort}
                        style={{
                          padding: '0.75rem 1.25rem',
                          background: nameSortOrder ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                          color: nameSortOrder ? 'white' : '#667eea',
                          border: nameSortOrder ? 'none' : '2px solid #667eea',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: nameSortOrder ? '0 4px 12px rgba(102, 126, 234, 0.3)' : 'none',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.transform = 'scale(1.05)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {nameSortOrder === 'asc' ? 'ğŸ”¼' : nameSortOrder === 'desc' ? 'ğŸ”½' : 'ğŸ”¤'}
                        ê°€ë‚˜ë‹¤ë¶„ë¥˜
                      </button>

                      {/* ì„±ë³„ìˆœ ì •ë ¬ ë²„íŠ¼ */}
                      <button
                        onClick={toggleGenderSort}
                        style={{
                          padding: '0.75rem 1.25rem',
                          background: genderSortOrder ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'white',
                          color: genderSortOrder ? 'white' : '#f5576c',
                          border: genderSortOrder ? 'none' : '2px solid #f5576c',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: genderSortOrder ? '0 4px 12px rgba(245, 87, 108, 0.3)' : 'none',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.transform = 'scale(1.05)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {genderSortOrder === 'male-first' ? 'ğŸ‘¦ğŸ‘§' : genderSortOrder === 'female-first' ? 'ğŸ‘§ğŸ‘¦' : 'âš¥'}
                        ì„±ë³„ë¶„ë¥˜
                      </button>

                      {/* ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */}
                      <button
                        onClick={downloadExcel}
                        title="ì—‘ì…€ íŒŒì¼ì€ ê·€í•˜ì˜ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤"
                        style={{
                          padding: '0.75rem 1.5rem',
                          background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.95rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: '0 4px 12px rgba(17, 153, 142, 0.3)',
                          transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                        onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                      >
                        <Download />
                        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                      </button>
                    </div>
                  </div>

                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                    gap: '1.5rem'
                  }}>
                    {results.map((cls, idx) => (
                      <div
                        key={cls.name}
                        style={{
                          background: `linear-gradient(135deg, ${
                            ['#a8edea', '#fbc2eb', '#fed6e3', '#a6c1ee', '#ffecd2'][idx % 5]
                          } 0%, ${
                            ['#fed6e3', '#a6c1ee', '#ffecd2', '#a8edea', '#fbc2eb'][idx % 5]
                          } 100%)`,
                          borderRadius: '16px',
                          padding: '1.5rem',
                          boxShadow: '0 10px 30px rgba(0, 0, 0, 0.15)'
                        }}
                      >
                        <h4 style={{
                          fontSize: '1.5rem',
                          fontWeight: '700',
                          marginBottom: '1rem',
                          color: '#333'
                        }}>
                          {cls.name}ë°˜
                        </h4>

                        <div style={{
                          background: 'rgba(255, 255, 255, 0.7)',
                          padding: '0.75rem',
                          borderRadius: '12px',
                          marginBottom: '1rem',
                          fontSize: '0.9rem',
                          fontWeight: '600'
                        }}>
                          <div>ì´ {cls.students.length}ëª…</div>
                          <div>ë‚¨ì„± {cls.maleCount}ëª… / ì—¬ì„± {cls.femaleCount}ëª…</div>
                          
                          {/* íŠ¹ì´ì‚¬í•­ í†µê³„ */}
                          {(() => {
                            const specialStats = {};
                            cls.students.forEach(student => {
                              const notes = studentSpecialNotes[student.id] || [];
                              const isMale = student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M';
                              
                              notes.forEach(note => {
                                if (!specialStats[note]) {
                                  specialStats[note] = { male: 0, female: 0 };
                                }
                                if (isMale) {
                                  specialStats[note].male++;
                                } else {
                                  specialStats[note].female++;
                                }
                              });
                            });
                            
                            // íŠ¹ì´ì‚¬í•­ ìˆœì„œ ê³ ì •
                            const noteOrder = ['ìš´ë™ë¶€', 'ë„ì›€ë°˜', 'ìŒìƒì•„', 'ë‹¤ë¬¸í™”'];
                            const orderedStats = noteOrder
                              .filter(note => specialStats[note])
                              .map(note => [note, specialStats[note]]);
                            
                            if (orderedStats.length === 0) return null;
                            
                            return (
                              <div style={{ 
                                marginTop: '0.5rem', 
                                paddingTop: '0.5rem', 
                                borderTop: '1px solid rgba(255,255,255,0.3)',
                                fontSize: '0.85rem',
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '0.4rem'
                              }}>
                                {orderedStats.map(([note, counts]) => {
                                  const parts = [];
                                  if (counts.male > 0) parts.push(`ë‚¨ì„± ${counts.male}ëª…`);
                                  if (counts.female > 0) parts.push(`ì—¬ì„± ${counts.female}ëª…`);
                                  return (
                                    <div key={note} style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '0.4rem'
                                    }}>
                                      <span style={{
                                        background: 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)',
                                        color: 'white',
                                        padding: '0.2rem 0.5rem',
                                        borderRadius: '4px',
                                        fontSize: '0.75rem',
                                        fontWeight: '600',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        {note}
                                      </span>
                                      <span style={{ color: '#333', fontWeight: '500' }}>
                                        {parts.join(', ')}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                            );
                          })()}
                        </div>

                        <div style={{
                          background: 'white',
                          borderRadius: '12px',
                          padding: '1rem'
                        }}>
                          {cls.students.map((student, sIdx) => {
                            const isSelected = selectedStudentsForSwap.some(
                              s => s.id === student.id && s.className === cls.name
                            );
                            
                            return (
                              <div
                                key={student.id}
                                onClick={() => handleStudentClickForSwap(student, cls.name)}
                                style={{
                                  padding: '0.75rem',
                                  borderBottom: sIdx < cls.students.length - 1 ? '1px solid #e0e0e0' : 'none',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  cursor: isResultEditMode ? 'pointer' : 'default',
                                  background: isSelected ? '#fff3cd' : 'transparent',
                                  borderRadius: '8px',
                                  transition: 'all 0.2s',
                                  border: '2px solid transparent'
                                }}
                                onMouseEnter={(e) => {
                                  if (isResultEditMode) {
                                    e.currentTarget.style.background = isSelected ? '#fff3cd' : '#f0f7ff';
                                    e.currentTarget.style.border = '2px solid #667eea';
                                    e.currentTarget.style.transform = 'translateX(4px)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.2)';
                                    const hint = e.currentTarget.querySelector('.click-hint');
                                    if (hint) hint.style.display = 'inline-block';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (isResultEditMode) {
                                    e.currentTarget.style.background = isSelected ? '#fff3cd' : 'transparent';
                                    e.currentTarget.style.border = '2px solid transparent';
                                    e.currentTarget.style.transform = 'translateX(0)';
                                    e.currentTarget.style.boxShadow = 'none';
                                    const hint = e.currentTarget.querySelector('.click-hint');
                                    if (hint) hint.style.display = 'none';
                                  }
                                }}
                              >
                                <span style={{ 
                                  fontWeight: isSelected ? '700' : '500',
                                  color: '#333',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.5rem',
                                  flex: 1
                                }}>
                                  {isSelected && (
                                    <span style={{
                                      display: 'inline-flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      width: '20px',
                                      height: '20px',
                                      background: '#ffc107',
                                      borderRadius: '50%',
                                      fontSize: '0.75rem',
                                      fontWeight: '700',
                                      color: '#fff'
                                    }}>
                                      âœ“
                                    </span>
                                  )}
                                  {student.name}
                                  {studentSpecialNotes[student.id]?.length > 0 && (
                                    <span style={{
                                      fontSize: '0.7rem',
                                      padding: '0.15rem 0.4rem',
                                      background: '#e67e22',
                                      color: 'white',
                                      borderRadius: '4px',
                                      fontWeight: '600'
                                    }}>
                                      {studentSpecialNotes[student.id].join(', ')}
                                    </span>
                                  )}
                                  {isResultEditMode && (
                                    <span 
                                      className="click-hint"
                                      style={{
                                        fontSize: '0.7rem',
                                        padding: '0.2rem 0.5rem',
                                        background: '#667eea',
                                        color: 'white',
                                        borderRadius: '4px',
                                        fontWeight: '600',
                                        marginLeft: 'auto',
                                        display: 'none'
                                      }}
                                    >
                                      ğŸ‘† í´ë¦­í•˜ì—¬ êµì²´
                                    </span>
                                  )}
                                </span>
                                <span style={{
                                  padding: '0.25rem 0.5rem',
                                  borderRadius: '8px',
                                  background: student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? '#e3f2fd' : '#fce4ec',
                                  color: student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? '#1976d2' : '#c2185b',
                                  fontSize: '0.85rem',
                                  fontWeight: '600'
                                }}>
                                  {student.gender === 'ë‚¨ì„±' || student.gender === 'ë‚¨' || student.gender === 'M' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}
                                </span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* ê²°ê³¼ ì €ì¥/ìˆ˜ì • ë²„íŠ¼ */}
                  <div style={{ textAlign: 'center', marginTop: '2rem' }}>
                    {isResultEditMode && (
                      <div style={{
                        marginBottom: '1rem',
                        padding: '1rem',
                        background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)',
                        borderRadius: '12px',
                        fontSize: '0.95rem',
                        color: '#1565c0',
                        fontWeight: '600',
                        display: 'inline-block'
                      }}>
                        ğŸ’¡ í•™ìƒ ì´ë¦„ì„ í´ë¦­í•˜ì—¬ ë°˜ì„ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                      </div>
                    )}
                    
                    <div style={{ 
                      display: 'flex', 
                      gap: '1rem', 
                      justifyContent: 'center',
                      flexWrap: 'wrap'
                    }}>
                      {/* ê²°ê³¼ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ */}
                      {isResultSaved && (
                        <button
                          onClick={toggleResultEdit}
                          style={{
                            padding: '1rem 2.5rem',
                            background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '1.1rem',
                            fontWeight: '700',
                            cursor: 'pointer',
                            boxShadow: '0 8px 20px rgba(240, 147, 251, 0.4)',
                            transition: 'transform 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                          onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                        >
                          ê²°ê³¼ ìˆ˜ì •í•˜ê¸°
                        </button>
                      )}
                      
                      {/* ë°˜í¸ì„± ê²°ê³¼ ì €ì¥í•˜ê¸° ë²„íŠ¼ */}
                      {!isResultSaved && (
                        <button
                          onClick={toggleResultSave}
                          style={{
                            padding: '1rem 2.5rem',
                            background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '1.1rem',
                            fontWeight: '700',
                            cursor: 'pointer',
                            boxShadow: '0 8px 20px rgba(17, 153, 142, 0.4)',
                            transition: 'transform 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                          onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                        >
                          ë°˜í¸ì„± ê²°ê³¼ ì €ì¥í•˜ê¸°
                        </button>
                      )}
                    </div>
                    
                    {isResultEditMode && selectedStudentsForSwap.length > 0 && (
                      <div style={{
                        marginTop: '1.5rem',
                        padding: '1.5rem',
                        background: selectedStudentsForSwap.length === 1 ? '#e3f2fd' : '#fff3cd',
                        borderRadius: '12px',
                        textAlign: 'center'
                      }}>
                        {selectedStudentsForSwap.length === 1 ? (
                          <div>
                            <div style={{ 
                              fontSize: '1rem',
                              color: '#1976d2',
                              fontWeight: '600',
                              marginBottom: '1rem'
                            }}>
                              ğŸ“Œ {selectedStudentsForSwap[0].name} í•™ìƒì„ ì´ë™ì‹œí‚¬ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”
                            </div>
                            <div style={{
                              display: 'flex',
                              gap: '0.75rem',
                              justifyContent: 'center',
                              flexWrap: 'wrap'
                            }}>
                              {results
                                .filter(cls => cls.name !== selectedStudentsForSwap[0].className)
                                .map(cls => (
                                  <button
                                    key={cls.name}
                                    onClick={() => {
                                      moveStudentToClass(selectedStudentsForSwap[0], cls.name);
                                    }}
                                    style={{
                                      padding: '0.75rem 1.5rem',
                                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                      color: 'white',
                                      border: 'none',
                                      borderRadius: '8px',
                                      fontSize: '0.95rem',
                                      fontWeight: '600',
                                      cursor: 'pointer',
                                      boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.target.style.transform = 'scale(1.05)';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.target.style.transform = 'scale(1)';
                                    }}
                                  >
                                    {cls.name}ë°˜ìœ¼ë¡œ ì´ë™
                                  </button>
                                ))}
                            </div>
                            <button
                              onClick={() => setSelectedStudentsForSwap([])}
                              style={{
                                marginTop: '1rem',
                                padding: '0.5rem 1rem',
                                background: 'white',
                                color: '#666',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                fontSize: '0.85rem',
                                cursor: 'pointer'
                              }}
                            >
                              ì·¨ì†Œ
                            </button>
                          </div>
                        ) : (
                          <div style={{ 
                            fontSize: '0.95rem',
                            color: '#856404',
                            fontWeight: '600'
                          }}>
                            âœ“ {selectedStudentsForSwap.length}ëª… ì„ íƒë¨ - {2 - selectedStudentsForSwap.length}ëª… ë” ì„ íƒí•˜ì—¬ ë°˜ êµì²´
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* í•™ê¸‰ ìˆ˜ ì„ íƒ ëª¨ë‹¬ */}
          {showClassModal && (
            <div
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem'
              }}
              onClick={() => setShowClassModal(false)}
            >
              <div
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '100%',
                  boxShadow: '0 25px 50px rgba(0, 0, 0, 0.3)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '1.5rem',
                  paddingBottom: '1rem',
                  borderBottom: '2px solid #e0e0e0'
                }}>
                  <h3 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#333', margin: 0 }}>
                    í•™ê¸‰ ìˆ˜ ì„ íƒ
                  </h3>
                  <button
                    onClick={() => setShowClassModal(false)}
                    style={{
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      padding: '0.5rem',
                      color: '#999'
                    }}
                  >
                    <X />
                  </button>
                </div>

                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(5, 1fr)',
                  gap: '1rem',
                  marginBottom: '1rem'
                }}>
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                    <button
                      key={num}
                      onClick={() => selectNumClasses(num)}
                      style={{
                        padding: '1.5rem 1rem',
                        background: numClasses === num
                          ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                          : '#f5f5f5',
                        color: numClasses === num ? 'white' : '#333',
                        border: 'none',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontWeight: '700',
                        fontSize: '1.5rem',
                        transition: 'all 0.2s',
                        boxShadow: numClasses === num
                          ? '0 4px 12px rgba(79, 172, 254, 0.4)'
                          : 'none'
                      }}
                    >
                      {num}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* ì¹´í…Œê³ ë¦¬ ì„ íƒ ëª¨ë‹¬ */}
          {showCategoryModal && (
            <div
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem'
              }}
              onClick={() => setShowCategoryModal(false)}
            >
              <div
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '600px',
                  width: '100%',
                  boxShadow: '0 25px 50px rgba(0, 0, 0, 0.3)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '1.5rem',
                  paddingBottom: '1rem',
                  borderBottom: '2px solid #e0e0e0'
                }}>
                  <h3 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#333', margin: 0 }}>
                    í•™ìƒ íŠ¹ì„± ì¹´í…Œê³ ë¦¬ ì„ íƒ
                  </h3>
                  <button
                    onClick={() => setShowCategoryModal(false)}
                    style={{
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      padding: '0.5rem',
                      color: '#999'
                    }}
                  >
                    <X />
                  </button>
                </div>

                <p style={{ 
                  color: '#666', 
                  marginBottom: '1.5rem',
                  fontSize: '0.95rem'
                }}>
                  ì¶”ê°€í•  íŠ¹ì„±ì„ ì„ íƒí•˜ì„¸ìš”. ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒì´ ì·¨ì†Œë©ë‹ˆë‹¤.
                </p>

                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(2, 1fr)',
                  gap: '1rem',
                  marginBottom: '1.5rem'
                }}>
                  {categoryExamples.map(catName => {
                    const isAdded = categories.some(cat => cat.name === catName);
                    return (
                      <button
                        key={catName}
                        onClick={() => toggleCategoryFromModal(catName)}
                        style={{
                          padding: '1.25rem',
                          background: isAdded
                            ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                            : 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                          color: isAdded ? 'white' : '#8b4513',
                          border: 'none',
                          borderRadius: '12px',
                          cursor: 'pointer',
                          fontWeight: '600',
                          fontSize: '1.1rem',
                          transition: 'all 0.2s',
                          boxShadow: isAdded 
                            ? '0 4px 12px rgba(102, 126, 234, 0.4)' 
                            : '0 4px 12px rgba(252, 182, 159, 0.3)',
                          position: 'relative',
                          transform: 'scale(1)'
                        }}
                        onMouseEnter={(e) => {
                          if (!isAdded) {
                            e.target.style.transform = 'scale(1.05)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {catName}
                        {isAdded && (
                          <span style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            fontSize: '1rem',
                            color: 'white'
                          }}>âœ“</span>
                        )}
                      </button>
                    );
                  })}
                </div>

                <div style={{ 
                  padding: '1rem',
                  background: '#f5f5f5',
                  borderRadius: '12px',
                  marginTop: '1rem'
                }}>
                  <p style={{ 
                    fontSize: '0.9rem', 
                    color: '#666',
                    margin: 0,
                    textAlign: 'center'
                  }}>
                    <strong>í˜„ì¬ {categories.length}ê°œ</strong>ì˜ ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                  </p>
                </div>

                <button
                  onClick={() => setShowCategoryModal(false)}
                  style={{
                    width: '100%',
                    marginTop: '1.5rem',
                    padding: '1rem',
                    background: 'linear-gradient(135deg, #8b4513 0%, #a0522d 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    fontSize: '1rem',
                    boxShadow: '0 4px 12px rgba(139, 69, 19, 0.3)'
                  }}
                >
                  ì™„ë£Œ
                </button>
              </div>
            </div>
          )}

          {/* ê°œì¸ì •ë³´ ë³´í˜¸ í‘¸í„° */}
          <div className="privacy-footer" style={{
            marginTop: '3rem',
            padding: '1.5rem',
            background: 'rgba(255, 255, 255, 0.1)',
            borderRadius: '12px',
            textAlign: 'center',
            border: '1px solid rgba(255, 255, 255, 0.2)'
          }}>
            <div style={{
              fontSize: '1.5rem',
              marginBottom: '0.5rem'
            }}>ğŸ”</div>
            <div style={{
              color: 'white',
              fontSize: '0.9rem',
              lineHeight: '1.6',
              maxWidth: '800px',
              margin: '0 auto'
            }}>
              <strong>ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆë‚´</strong><br/>
              ì´ í”„ë¡œê·¸ë¨ì€ 100% ë¡œì»¬ ì „ìš©ì…ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ëŠ” ê·€í•˜ì˜ ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥ë˜ë©°,<br/>
              ì„œë²„ë‚˜ ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.<br/>
              <span style={{ fontSize: '0.85rem', opacity: 0.9 }}>
                ê²°ê³¼ë¥¼ ë³´ê´€í•˜ë ¤ë©´ ë°˜ë“œì‹œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.
              </span>
              <br/><br/>
              <span style={{ fontSize: '0.85rem', opacity: 0.9 }}>
                * ìµœì¢…ì ì¸ ë°˜í¸ì„± ê¶Œí•œê³¼ ì±…ì„ì€ ì‚¬ìš©í•˜ì‹  ì„ ìƒë‹˜ê»˜ ìˆìŠµë‹ˆë‹¤.
              </span>
            </div>
          </div>
        </div>
        </div>
      );
    }

    ReactDOM.render(<ClassAssignment />, document.getElementById('root'));
  </script>
</body>
</html>
